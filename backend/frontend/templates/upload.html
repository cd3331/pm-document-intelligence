{% extends "base.html" %}

{% block title %}Upload Document - PM Document Intelligence{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-6">
    <!-- Page header -->
    <div>
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Upload Document</h1>
        <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">
            Upload PDF, DOCX, TXT, or image files for AI-powered analysis
        </p>
    </div>

    <!-- Upload area -->
    <div class="card">
        <form id="upload-form"
              hx-post="/api/v1/documents/upload"
              hx-encoding="multipart/form-data"
              hx-target="#upload-results"
              hx-swap="innerHTML"
              x-data="uploadHandler()">

            <!-- Drag and drop area -->
            <div @drop.prevent="handleDrop($event)"
                 @dragover.prevent="dragover = true"
                 @dragleave.prevent="dragover = false"
                 :class="{ 'border-joy-teal bg-joy-teal/5': dragover }"
                 class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-12 text-center transition-colors">

                <input type="file"
                       id="file-input"
                       name="files"
                       multiple
                       accept=".pdf,.docx,.doc,.txt,.png,.jpg,.jpeg"
                       @change="handleFileSelect($event)"
                       class="hidden">

                <div class="space-y-4">
                    <div class="mx-auto w-16 h-16 bg-joy-teal/10 rounded-full flex items-center justify-center">
                        <i class="fas fa-cloud-upload-alt text-3xl text-joy-teal"></i>
                    </div>

                    <div>
                        <button type="button"
                                onclick="document.getElementById('file-input').click()"
                                class="btn-primary">
                            <i class="fas fa-folder-open mr-2"></i> Choose Files
                        </button>
                        <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                            or drag and drop files here
                        </p>
                    </div>

                    <div class="text-xs text-gray-500 dark:text-gray-400">
                        <p>Supported formats: PDF, DOCX, TXT, PNG, JPG</p>
                        <p>Maximum file size: 10MB per file</p>
                    </div>
                </div>
            </div>

            <!-- Selected files list -->
            <div x-show="files.length > 0" class="mt-6 space-y-3">
                <div class="flex justify-between items-center">
                    <h3 class="font-semibold text-gray-900 dark:text-white">
                        Selected Files (<span x-text="files.length"></span>)
                    </h3>
                    <button type="button"
                            @click="files = []"
                            class="text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white">
                        Clear all
                    </button>
                </div>

                <template x-for="(file, index) in files" :key="index">
                    <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div class="flex items-center space-x-3 flex-1">
                            <i class="fas fa-file text-2xl text-gray-400"
                               :class="{
                                   'fa-file-pdf text-red-500': file.name.endsWith('.pdf'),
                                   'fa-file-word text-blue-500': file.name.endsWith('.docx') || file.name.endsWith('.doc'),
                                   'fa-file-alt text-gray-500': file.name.endsWith('.txt'),
                                   'fa-file-image text-green-500': file.name.endsWith('.png') || file.name.endsWith('.jpg') || file.name.endsWith('.jpeg')
                               }"></i>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-900 dark:text-white truncate"
                                   x-text="file.name"></p>
                                <p class="text-xs text-gray-600 dark:text-gray-400"
                                   x-text="formatFileSize(file.size)"></p>
                            </div>
                        </div>
                        <button type="button"
                                @click="removeFile(index)"
                                class="ml-4 text-gray-400 hover:text-red-500">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </template>
            </div>

            <!-- Upload options -->
            <div x-show="files.length > 0" class="mt-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Document Type
                    </label>
                    <select name="document_type"
                            class="input w-full">
                        <option value="general">General Document</option>
                        <option value="meeting_notes">Meeting Notes</option>
                        <option value="project_plan">Project Plan</option>
                        <option value="financial_report">Financial Report</option>
                        <option value="technical_doc">Technical Documentation</option>
                        <option value="contract">Contract</option>
                    </select>
                </div>

                <div class="flex items-center">
                    <input type="checkbox"
                           name="auto_analyze"
                           id="auto_analyze"
                           checked
                           class="rounded border-gray-300 text-joy-teal focus:ring-joy-teal">
                    <label for="auto_analyze" class="ml-2 text-sm text-gray-700 dark:text-gray-300">
                        Automatically analyze documents after upload
                    </label>
                </div>

                <!-- Submit button -->
                <button type="submit"
                        :disabled="uploading"
                        class="btn-primary w-full"
                        :class="{ 'opacity-50 cursor-not-allowed': uploading }">
                    <template x-if="!uploading">
                        <span><i class="fas fa-upload mr-2"></i> Upload Files</span>
                    </template>
                    <template x-if="uploading">
                        <span><i class="fas fa-spinner fa-spin mr-2"></i> Uploading...</span>
                    </template>
                </button>
            </div>
        </form>

        <!-- Upload results -->
        <div id="upload-results" class="mt-6"></div>
    </div>

    <!-- Upload history -->
    <div class="card">
        <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Recent Uploads</h2>
        <div id="upload-history"
             hx-get="/api/documents/recent?limit=10"
             hx-trigger="load, uploadComplete from:body"
             hx-swap="innerHTML">
            <!-- Loading -->
            <div class="text-center py-8">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-joy-teal mx-auto"></div>
                <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">Loading...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function uploadHandler() {
    return {
        files: [],
        dragover: false,
        uploading: false,

        handleFileSelect(event) {
            this.addFiles(event.target.files);
        },

        handleDrop(event) {
            this.dragover = false;
            this.addFiles(event.dataTransfer.files);
        },

        addFiles(fileList) {
            const maxSize = 10 * 1024 * 1024; // 10MB
            const allowedTypes = ['.pdf', '.docx', '.doc', '.txt', '.png', '.jpg', '.jpeg'];

            Array.from(fileList).forEach(file => {
                // Check file size
                if (file.size > maxSize) {
                    showToast(`${file.name} is too large. Maximum size is 10MB.`, 'error');
                    return;
                }

                // Check file type
                const extension = '.' + file.name.split('.').pop().toLowerCase();
                if (!allowedTypes.includes(extension)) {
                    showToast(`${file.name} has an unsupported file type.`, 'error');
                    return;
                }

                this.files.push(file);
            });
        },

        removeFile(index) {
            this.files.splice(index, 1);
        },

        formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
    }
}

// Handle upload form submission
document.getElementById('upload-form').addEventListener('htmx:beforeRequest', function(event) {
    const alpineData = Alpine.$data(event.target);
    if (alpineData) {
        alpineData.uploading = true;
    }
});

document.getElementById('upload-form').addEventListener('htmx:afterRequest', function(event) {
    const alpineData = Alpine.$data(event.target);
    if (alpineData) {
        alpineData.uploading = false;

        if (event.detail.successful) {
            alpineData.files = [];
            document.getElementById('file-input').value = '';
            showToast('Files uploaded successfully!', 'success');

            // Trigger upload complete event
            document.body.dispatchEvent(new CustomEvent('uploadComplete'));
            document.body.dispatchEvent(new CustomEvent('documentUploaded'));
        }
    }
});
</script>
{% endblock %}
