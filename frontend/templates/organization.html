<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organization Dashboard - PM Document Intelligence</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Alpine.js for interactivity -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <style>
        [x-cloak] { display: none !important; }

        .tab-active {
            border-bottom: 2px solid #3b82f6;
            color: #3b82f6;
        }

        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }

        .progress-bar {
            transition: width 0.3s ease;
        }

        .quota-danger {
            background-color: #fee2e2;
            border-left: 4px solid #ef4444;
        }

        .quota-warning {
            background-color: #fef3c7;
            border-left: 4px solid #f59e0b;
        }

        .quota-ok {
            background-color: #d1fae5;
            border-left: 4px solid #10b981;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-admin { background-color: #dbeafe; color: #1e40af; }
        .badge-manager { background-color: #e0e7ff; color: #4338ca; }
        .badge-member { background-color: #e5e7eb; color: #374151; }
        .badge-viewer { background-color: #f3f4f6; color: #6b7280; }
    </style>
</head>
<body class="bg-gray-50">
    <div x-data="organizationDashboard()" x-cloak>
        <!-- Navigation Bar -->
        <nav class="bg-white shadow-sm mb-6">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <i class="fas fa-building text-2xl text-blue-600 mr-3"></i>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900" x-text="organization.name"></h1>
                            <p class="text-sm text-gray-500">
                                <span x-text="organization.plan" class="capitalize"></span> Plan
                                • <span x-text="organization.status" class="capitalize"></span>
                            </p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button @click="refreshData()" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh
                        </button>
                        <button @click="showUpgradeModal()" x-show="canUpgrade" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                            <i class="fas fa-arrow-up mr-2"></i>Upgrade Plan
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Tabs -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="border-b border-gray-200 mb-6">
                <nav class="-mb-px flex space-x-8">
                    <button @click="currentTab = 'overview'"
                            :class="currentTab === 'overview' ? 'tab-active' : 'text-gray-500 hover:text-gray-700'"
                            class="py-4 px-1 font-medium text-sm">
                        <i class="fas fa-tachometer-alt mr-2"></i>Overview
                    </button>
                    <button @click="currentTab = 'members'"
                            :class="currentTab === 'members' ? 'tab-active' : 'text-gray-500 hover:text-gray-700'"
                            class="py-4 px-1 font-medium text-sm">
                        <i class="fas fa-users mr-2"></i>Members
                    </button>
                    <button @click="currentTab = 'teams'"
                            :class="currentTab === 'teams' ? 'tab-active' : 'text-gray-500 hover:text-gray-700'"
                            class="py-4 px-1 font-medium text-sm">
                        <i class="fas fa-user-friends mr-2"></i>Teams
                    </button>
                    <button @click="currentTab = 'settings'"
                            :class="currentTab === 'settings' ? 'tab-active' : 'text-gray-500 hover:text-gray-700'"
                            class="py-4 px-1 font-medium text-sm">
                        <i class="fas fa-cog mr-2"></i>Settings
                    </button>
                    <button @click="currentTab = 'audit'"
                            :class="currentTab === 'audit' ? 'tab-active' : 'text-gray-500 hover:text-gray-700'"
                            class="py-4 px-1 font-medium text-sm">
                        <i class="fas fa-clipboard-list mr-2"></i>Audit Logs
                    </button>
                </nav>
            </div>

            <!-- Overview Tab -->
            <div x-show="currentTab === 'overview'" class="space-y-6">
                <!-- Usage Statistics Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <template x-for="(quota, name) in quotas" :key="name">
                        <div class="bg-white rounded-lg shadow p-6" :class="getQuotaClass(quota)">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-sm font-medium text-gray-500" x-text="formatQuotaName(name)"></h3>
                                <i class="fas" :class="getQuotaIcon(quota, name)"></i>
                            </div>
                            <div class="mb-2">
                                <p class="text-2xl font-bold text-gray-900">
                                    <span x-text="quota.current"></span>
                                    <span class="text-base text-gray-500">/ <span x-text="quota.limit"></span></span>
                                </p>
                            </div>
                            <div class="mb-2">
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="progress-bar h-2 rounded-full"
                                         :class="getProgressBarColor(quota)"
                                         :style="`width: ${Math.min(quota.percentage || 0, 100)}%`">
                                    </div>
                                </div>
                            </div>
                            <p class="text-xs text-gray-600" x-text="`${quota.percentage || 0}% used`"></p>
                        </div>
                    </template>
                </div>

                <!-- Quota Warnings -->
                <div x-show="warnings.length > 0" class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                    <div class="flex">
                        <i class="fas fa-exclamation-triangle text-yellow-400 mt-0.5"></i>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-yellow-800">Quota Warnings</h3>
                            <div class="mt-2 text-sm text-yellow-700">
                                <ul class="list-disc list-inside space-y-1">
                                    <template x-for="warning in warnings" :key="warning.quota">
                                        <li>
                                            <span x-text="formatQuotaName(warning.quota)"></span>:
                                            <span x-text="`${warning.percentage}% used (${warning.current}/${warning.limit})`"></span>
                                        </li>
                                    </template>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Plan Features -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold mb-4">Plan Features</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <template x-for="(enabled, feature) in features" :key="feature">
                            <div class="flex items-center">
                                <i class="fas mr-2" :class="enabled ? 'fa-check-circle text-green-500' : 'fa-times-circle text-gray-400'"></i>
                                <span :class="enabled ? 'text-gray-900' : 'text-gray-400'" x-text="formatFeatureName(feature)"></span>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold mb-4">Recent Activity</h2>
                    <div class="space-y-3">
                        <template x-for="log in recentActivity" :key="log.id">
                            <div class="flex items-start">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-circle text-xs text-gray-400 mt-2"></i>
                                </div>
                                <div class="ml-3 flex-1">
                                    <p class="text-sm text-gray-900">
                                        <span class="font-medium" x-text="log.username || 'System'"></span>
                                        <span x-text="log.action"></span>
                                    </p>
                                    <p class="text-xs text-gray-500" x-text="formatDate(log.timestamp)"></p>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Members Tab -->
            <div x-show="currentTab === 'members'" class="space-y-6">
                <div class="bg-white rounded-lg shadow">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h2 class="text-lg font-semibold">Organization Members</h2>
                            <button @click="showInviteModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                <i class="fas fa-user-plus mr-2"></i>Invite Member
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">User</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Joined</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template x-for="member in members" :key="member.id">
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div>
                                                <div class="text-sm font-medium text-gray-900" x-text="member.username"></div>
                                                <div class="text-sm text-gray-500" x-text="member.email"></div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="badge" :class="`badge-${member.role}`" x-text="member.role"></span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="formatDate(member.joined_at)"></td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 py-1 text-xs rounded-full"
                                                  :class="member.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'"
                                                  x-text="member.is_active ? 'Active' : 'Inactive'"></span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm">
                                            <button @click="editMemberRole(member)" class="text-blue-600 hover:text-blue-900 mr-3">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button @click="removeMember(member)" class="text-red-600 hover:text-red-900">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Pending Invitations -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">Pending Invitations</h3>
                    <div class="space-y-3">
                        <template x-for="invitation in pendingInvitations" :key="invitation.id">
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div>
                                    <p class="text-sm font-medium text-gray-900" x-text="invitation.email"></p>
                                    <p class="text-xs text-gray-500">
                                        Role: <span x-text="invitation.role"></span> •
                                        Expires: <span x-text="formatDate(invitation.expires_at)"></span>
                                    </p>
                                </div>
                                <div class="flex space-x-2">
                                    <button @click="resendInvitation(invitation.id)" class="text-blue-600 hover:text-blue-900">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                    <button @click="cancelInvitation(invitation.id)" class="text-red-600 hover:text-red-900">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </template>
                        <p x-show="pendingInvitations.length === 0" class="text-gray-500 text-sm">No pending invitations</p>
                    </div>
                </div>
            </div>

            <!-- Teams Tab -->
            <div x-show="currentTab === 'teams'" class="space-y-6">
                <div class="bg-white rounded-lg shadow">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h2 class="text-lg font-semibold">Teams</h2>
                            <button @click="showCreateTeamModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                <i class="fas fa-plus mr-2"></i>Create Team
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <template x-for="team in teams" :key="team.id">
                                <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md transition cursor-pointer" @click="viewTeam(team)">
                                    <div class="flex items-center justify-between mb-4">
                                        <h3 class="text-lg font-semibold text-gray-900" x-text="team.name"></h3>
                                        <i class="fas fa-chevron-right text-gray-400"></i>
                                    </div>
                                    <p class="text-sm text-gray-600 mb-4" x-text="team.description || 'No description'"></p>
                                    <div class="flex items-center text-sm text-gray-500">
                                        <i class="fas fa-users mr-2"></i>
                                        <span x-text="`${team.member_count} members`"></span>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <p x-show="teams.length === 0" class="text-gray-500 text-center py-8">No teams yet. Create your first team!</p>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div x-show="currentTab === 'settings'" class="space-y-6">
                <form @submit.prevent="saveSettings()" class="bg-white rounded-lg shadow p-6 space-y-6">
                    <h2 class="text-lg font-semibold mb-4">Organization Settings</h2>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Organization Name</label>
                        <input type="text" x-model="settings.name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Contact Email</label>
                            <input type="email" x-model="settings.contact_email" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Contact Phone</label>
                            <input type="tel" x-model="settings.contact_phone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Logo URL</label>
                        <input type="url" x-model="settings.logo_url" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Primary Color</label>
                        <div class="flex items-center space-x-3">
                            <input type="color" x-model="settings.primary_color" class="h-10 w-20 rounded cursor-pointer">
                            <input type="text" x-model="settings.primary_color" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>

                    <div class="pt-4">
                        <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Save Settings
                        </button>
                    </div>
                </form>

                <!-- Danger Zone -->
                <div class="bg-white rounded-lg shadow p-6 border-2 border-red-200">
                    <h2 class="text-lg font-semibold text-red-600 mb-4">Danger Zone</h2>
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-sm font-medium text-gray-900">Delete Organization</h3>
                            <p class="text-sm text-gray-500">Permanently delete this organization and all associated data.</p>
                        </div>
                        <button @click="showDeleteConfirmation()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                            Delete Organization
                        </button>
                    </div>
                </div>
            </div>

            <!-- Audit Logs Tab -->
            <div x-show="currentTab === 'audit'" class="space-y-6">
                <div class="bg-white rounded-lg shadow">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-semibold">Audit Logs</h2>
                            <button @click="exportAuditLogs()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                                <i class="fas fa-download mr-2"></i>Export
                            </button>
                        </div>
                        <!-- Filters -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <input type="text" x-model="auditFilters.action" placeholder="Filter by action" class="px-3 py-2 border border-gray-300 rounded-lg">
                            <input type="text" x-model="auditFilters.user" placeholder="Filter by user" class="px-3 py-2 border border-gray-300 rounded-lg">
                            <input type="date" x-model="auditFilters.startDate" class="px-3 py-2 border border-gray-300 rounded-lg">
                            <button @click="loadAuditLogs()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                Apply Filters
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Timestamp</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">User</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Action</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Resource</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Details</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template x-for="log in auditLogs" :key="log.id">
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="formatDateTime(log.timestamp)"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="log.username || 'System'"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="log.action"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            <span x-text="log.resource_type || '-'"></span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 py-1 text-xs rounded-full"
                                                  :class="log.status === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                                                  x-text="log.status"></span>
                                        </td>
                                        <td class="px-6 py-4 text-sm text-gray-500">
                                            <button @click="viewLogDetails(log)" class="text-blue-600 hover:text-blue-900">
                                                View
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Invite Member Modal -->
        <div x-show="modals.invite" @click.self="modals.invite = false" class="fixed inset-0 z-50 flex items-center justify-center modal-overlay" style="display: none;">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md" @click.stop>
                <h3 class="text-lg font-semibold mb-4">Invite Team Member</h3>
                <form @submit.prevent="sendInvitation()">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                            <input type="email" x-model="inviteForm.email" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                            <select x-model="inviteForm.role" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="viewer">Viewer</option>
                                <option value="member">Member</option>
                                <option value="manager">Manager</option>
                                <option value="org_admin">Organization Admin</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button type="button" @click="modals.invite = false" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">
                            Cancel
                        </button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Send Invitation
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="/static/js/organization.js"></script>
</body>
</html>
